# コーディング規約（GDScript）

## 1. 命名

**命名は全て英語のみで構成する**

| 対象 | スタイル | 例 |
|------|----------|-----|
| 変数/関数 | `snake_case` | `move_speed`, `get_player()` |
| 定数 | `UPPER_SNAKE_CASE` | `MAX_HP`, `IDLE_POSITION` |
| クラス名 | `PascalCase` | `ChasePlayer`, `RpgPlayer` |
| ファイル名 | `snake_case.gd` | `chase_player.gd` |
| ノード参照 | `@onready var xxx: Type = %Name` | `@onready var _sprite: AnimatedSprite2D = %AnimatedSprite` |

## 2. 型注釈

- 可能な限り型注釈を付ける（Godot 4.x の静的チェックを活かす）
- 必要に応じて `class_name` を付与し、型推論を活用する
- null の可能性がある参照はガード節で守る

## 3. コメント

**【絶対ルール】全てのコードに、そのコードがどのような処理をしているか日本語で簡潔にコメントを記述すること。**

- **全ての関数・メソッド:** 冒頭に `##` で「何をする関数か」を1行で記述する
- **全てのクラス:** 冒頭に `##` で「このクラスの責務」を記述する
- **全ての変数・定数:** `##` で用途・役割を記述する（自明な場合はインラインコメントでも可）
- **全ての処理ブロック:** if 分岐・ループ・シグナル接続など、処理の意図がわかるコメントを付ける
- 複雑な処理や意図が読みにくいコードには「なぜこの実装か」を追加する
- 類似処理が並ぶ場合はひとまとめのコメントにする

## 4. ログ

- `Log` オートロードを使用し、`print()` は使用しない
- **基本的に `Log.debug()` を使用する。** `Log.info()` は特に重要な情報（初期化完了、致命的な状態変化など）にのみ用いる
- 重要またはバグが発生しやすいメソッドには追跡用ログを出力する
- エラーは握りつぶさず、原因が追える情報を残す

## 5. コード品質

**常に「拡張性・保守性・可読性」を最優先して実装/改修すること。**

- **拡張性:** 新機能追加時に既存コードの変更範囲が最小で済む構造。**GodotのResource機能を積極的に使用する**
- **保守性:** 表示文言や UI 構造変更に強い実装（文字列 match 依存を避ける）
- **可読性:** 意図がコードから読み取れる命名・関数分割・データ駆動
- **パラメータは export 変数で定義:** HP・攻撃力・速度・クールダウン等のゲームパラメータは `@export` 変数として定義し、Inspector から調整可能にする。定数（`const`）はゲームデザインに無関係な内部値にのみ使用する
- **フォールバック処理は絶対に使用しない:** 以下のコーディングは禁止。
1. 呼び出し先にメソッド/プロパティが存在するか明示的に確認し、存在しない場合は早期リターンまたはエラーログで処理する。
2. デフォルト値で暗黙に処理を続行する。

### スクリプト分割の判断基準

**内部クラスを使う場合:**
- そのファイル専用の小型 DTO / 状態マシンの State 群

**別ファイルに分割する場合:**
- 複数シーン/スクリプトから再利用したい
- Inspector で割り当てたい / Resource として保存したい
- 単体テスト対象として独立させたい
- ファイルが肥大化し、責務が 3 つ以上混在

## 6. リソースパスの指定

**コード内でリソースパスを指定する際は、原則として Godot の UID（`uid://` 形式）を使用する。**

- `res://` パスはファイルの移動・リネーム時に参照が壊れるが、UID はファイルシステム上の変更に影響されない
- `preload()` / `load()` の引数、`@export_file` のデフォルト値、定数でのパス定義はすべて UID を使用する
- UID は各ファイルの `.uid` ファイルに記録されている。MCP の `get_uid` ツールで取得可能

```gdscript
# --- 良い例 ---
const SCENE: PackedScene = preload("uid://abc123def456")
GameManager.load_scene_with_transition("uid://abc123def456")

# --- 悪い例 ---
const SCENE: PackedScene = preload("res://root/scenes/some_scene.tscn")
GameManager.load_scene_with_transition("res://root/scenes/some_scene.tscn")
```

### 例外

以下のケースでは `res://` や `user://` パスの使用を許可する:
- `user://` パス（セーブデータ等、UID が存在しないユーザーデータ領域）
- 動的にパスを組み立てる場合（UID が事前に確定しない場合）
- `.gitignore` 対象やエディタ専用の設定ファイル
